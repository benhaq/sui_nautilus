# Oyster CVM docker-compose.yml for medical-vault-insurer deployment
# Reference: https://docs.marlin.org/oyster/build-cvm/quickstart
#
# IMPORTANT: Use image digest (sha256), NOT tags, for reproducible deployments
#
# Build and push:
#   docker build -f Dockerfile.oyster -t myregistry/medical-vault-insurer:latest .
#   docker push myregistry/medical-vault-insurer:latest
#   DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' myregistry/medical-vault-insurer:latest)
#   # Update image: line below with the digest
#
# Deploy:
#   oyster-cvm deploy --wallet-private-key $PRIVATE_KEY --docker-compose docker-compose.oyster.yml --deployment sui

version: "3.8"

services:
  nautilus-server:
    # IMPORTANT: Use image digest (sha256:...), NOT tags like :latest
    # Get digest after pushing: docker inspect --format='{{index .RepoDigests 0}}' docker.io/username/nautilus-server
    #
    # Example digest (replace with your pushed image):
    # image: docker.io/username/nautilus-server@sha256:abc123...
    image: docker.io/12091999/nautilus-server@sha256:b660c4f551692e1e6f7ca874ed9d1c001e90d42cacefe2eb3260dd47c23d5567

    container_name: nautilus-server
    restart: unless-stopped
    init: true

    # Oyster CVM requires host network mode
    network_mode: host

    # Required for Nitro Enclaves
    volumes:
      # Optional: Mount configuration file if needed
      - ./src/apps/medical-vault-insurer/seal_config.yaml:/app/config.yaml:ro
      - ./ecdsa.key:/app/ecdsa.sec:ro
    environment:
      # OpenRouter API key for LLM inference (required for medical-vault-insurer)
      # Set this to provision the API key at startup - needed for Oyster CVM where admin endpoints are not accessible
      # - OPENROUTER_API_KEY=sk-or-v1-...

    # Health check for Oyster monitoring
    healthcheck:
      test:
        ["CMD", "wget", "-q", "--spider", "http://localhost:3000/health_check"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# Notes:
# - Oyster CVM automatically exposes port 1301 for attestation service
# - Main API runs on port 3000
# - Admin endpoints run on port 3001
# - PCR values are computed from this docker-compose.yml configuration
# - Use 'oyster-cvm compute-image-id --docker-compose docker-compose.oyster.yml' to get expected image ID
